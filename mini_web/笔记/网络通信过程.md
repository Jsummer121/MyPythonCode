# 网路通信过程

在现实中，如果一台电脑想要上网，那就需要插入网线。与此同时，你的电脑就会分配一个ip给你，你可以根据这个ip进行一些“有趣”的操作。

## 一、 两台电脑间通信

平时，如果想让两台电脑之间进行通信，可以通过一条网线将两个电脑进行相连。我们只需要设定这两台电脑的ip和子网掩码即可。

![img](imgs\QQ20170807-210222@2x.png)

例如：一台电脑的ip地址为192.168.1.2，那么此时另一台ip应该为192.168.1.n（3<b<224）。然后将子网掩码设置成255.255.255.0。有可能会问，这个子网掩码是干啥用的呢？

IP地址由网络标识（netid）和主机标识（hostid）两部分组成，网络标识用来区分Internet上互联的各个网络，主机标识用来区分同一网络上的不同计算机（即主机）。IP地址由4部分数字组成，每部分都不大于256，各部分之间用小数点分开。IP地址通常分为三类： 
**A类**：IP地址的前8位表示网络号，后24位表示主机号。
**B类**：IP地址的前16位表示网络号，后16位表示主机号。
**C类**：IP地址的前24位表示网络号，后8位表示主机号。

那么我们如何确定这个ip地址是第几类呢？回去看我们的子网掩码，我们自己在家里的ip一般都为c类IP，此时ip的前24位是网络号，后面8位表示主机号，因此我们使用子网掩码为255.255.255.0来表示我们是c类的，然后利用与运算就可以算出实际的ip地址了。那如果我们是b类的ip，推导一下那我们的子网掩码也就变成了255.255.0.0了。

当配置完这些之后，我们就可以通过一条网线让这两台电脑进行相互通信了。

## 二、 多台相同网段下的电脑之间通信

按照我们电路的思想，在一个电路中，如果再想接入一个灯泡，此时我们可以在两个灯泡之间接入一个新的灯泡即可。网线可以么？我们在两台电脑之间断开然后接入一个网线然后插入第三个电脑可行么？答案是不行的，电脑之间传输数据是依靠电流的高低进行数据传输的，如果断开一个条线然后接入新的电脑就会使原始的数据发生错误。

### 2.1 使用集线器组成一个网络

![img](imgs\QQ20170807-210413@2x.png)

以前，人们会使用集线器来使多个电脑互连，比如，PC3发送一个数据包，此时PC4和PC5都能顺利收到这个数据包（也是我们俗称的广播）。但如果PC4同时也想发一个消息给PC5呢？此时就会产生网络拥堵，因为必须要等PC3的数据发送到之后再由PC4发送。那么总结一下：

1. 当有多态电脑需要组成一个网时，那么可以通过集线器（Hub）将其链接在一起
2. 一般情况下集线器的接口较少
3. 集线器有个缺点，它以广播的方式进行发送任何数据，即如果集线器接收到来自A电脑的数据本来是想转发给B电脑，如果此时它还连接着另外两台电脑C、D，那么它会把这个数据给每个电脑都发送一份，因此会导致网络拥堵

### 2.2 使用交换机组成一个网络

![img](imgs\QQ20170807-211152@2x.png)

由于集线器存在的一些问题，后续人们研发出了交换机，这个交换器解决了集线器发送数据只能群发的毛病，它利用每个网卡的序列号（mac地址）来进行通信，例如上图的Switch0，它的左边和右边一共有三个接口分别与三台电脑相连。

![img](imgs\1355668682_9897.jpg)

在说mac地址前需要知道在TCP/IP协议中。

1.数据从客户端发送到服务器需要从客户端的应用层开始，然后利用应用程序的相关协议包装这个数据，再由应用层发往传输层。

2.此时可以选择用TCP协议还是UDP协议，如果是TCP协议就在这个数据包的头部加上属于TCP的表头（即自己的端口号和服务器的端口号），再由传输层发往网络层。

3.此时就是在数据包的头部加上一个属于ip协议的表头（即自己的ip和服务器的ip），当加号表头以后，在发往数据链路层。

4.在这层需要在数据包的头部加上一个属于自己的表头（即自己的mac地址和服务器的mac地址）。

5.此时整个数据包已经算算完成了，这个数据包经过客户端的网卡通过路由器再由互联网发送到服务器。

6.然后由服务器的数据链路层查看属于自己协议的表头（如果数据包上的mac地址不是自己的mac地址那这个数据包就会被丢弃）

7.在网上一层一层的去掉表头到最上面的应用层根据相应软件的协议解析出数据之后就是我们所发的数据了。

#### 2.1 如何查询对方的mac地址

按照上面说的，发数据的时候需要写上对方的mac地址，但是第一次你并没有任何人的mac地址，这个怎么办呢?

一般在发数据之前，先会使用arp协议查看自己电脑里是否存在对方的mac地址，如果不存在，则利用ff.ff.ff.ff.ff.ff这个mac地址包装一个数据包发送一个广播（在数据包里面放了对方的ip地址），因为是广播的，谁都可以收到这个数据包。然后在由数据链路层发送到网络层，网络层判断这个ip是属于自己的，如果是，就会将自己的mac地址回送给客户端（此时不是广播了，因为发送过来数据的时候已经存在了发送方的mac地址）。然后arp协议就会记住这个ip对应的mac地址，便于后续的一系列操作。win中可以用`arp -a`查看存在的ip对应的mac地址。

#### 2.2 如何定向发送数据包

假如PC1想发送一个数据给PC2，又不想让PC3收到，他就会根据mac地址来进行精准发送，PC1在数据链路层写上自己的mac地址和PC2的mac地址，当数据包通过交换机的时候，他就会判断这个mac地址是属于PC2的，然后就会将这个数据包发送给PC2。同样PC2根据PC1写的mac地址就可以回送信息给PC1了。

## 三、实现不同网段下的电脑之间通信

我们身处万维网之中，世界上的每台电脑都不可能是和自己处在同一网段下的，因此我们要和不同网段下的电脑之间通信就需要借助路由器，使得C1网段中的电脑和C2网段中的电脑进行通信。

![img](imgs\QQ20170807-211021@2x.png)

上图中，我们用C1表示PC0所处的网段，用C2表示PC3所处的网段。我们上面已经知道如果PC1想和PC2之间通信可以通过交换机就能进行精准的数据传输，但是如果PC1想和PC3进行通信只用交换机是不行的。因为C1和C2是不同的网段，此时我们需要引入路由器R0，R0的左边的ip地址属于C1网段，R0右边的ip属于C2网段，然后利用路由器实现两端通信。

### 3.1 默认网关

正常的我们把R0左边的ip地址称为C1的默认网关，一般为M.M.X.1,同时RO右边的ip地址称为C2的默认网关也是M.M.X.1（这里的x表示任何数字与C1肯定不相同）。此时如果PC0想要发送信息给PC3，就需要先发送给R0左边的网卡，然后左边的网卡传送给R0右边的网卡，再由右边的网卡转发给PC3。

### 3.2 通信过程

我们假设PC0想要发送数据给PC3，此时他应该准备什么呢？

1.获取默认网关的ip，查看网关ip的mac是否存在自己的arp协议内。

2.如果不存在，则利用广播机制获取到默认网关的mac地址。

3.将自己所需要发送的信息通过TCP/IP协议进行封装(发送ip：PC1ip，接收ip：PC2ip。发送mac：PC1mac，接收mac：R0左mac)

4.RO左网卡接收到数据包之后将其传送给R0右边的网卡（发送ip：PC1ip，接收ip：PC2ip。发送mac：R0左mac，接收mac：R0右mac）

5.由R0右边的网卡负责转发，将该数据包发送给对应的ip即可。（发送ip：PC1ip，接收ip：PC2ip。发送mac：R0右mac，接收mac：PC2mac）

上面传输的时候，可以看到数据包内的ip地址不管在网卡之间怎么传输都是不变的，变得只是发送方mac地址和接受方mac地址。就相当于你要通过许多个人把礼物送给小明，明确的是你发送礼物，小明接收礼物，中间传给谁都是未知的。

## 四、复杂通信（访问www.baidu.com)

![img](imgs\QQ20170807-212411@2x.png)

当你在浏览器上输入一个www.baidu.com之后，百度服务器传送给你一个网页，这里到底经历了啥？

### 4.1 DNS域名解析

我们输入的所有url是一个由字符拼接组成的字符串，每个字符串都绑定这一个ip。并且我们知道HTTP协议使用的是TCP协议，并且在TCP协议中需要知道对方的ip才能进行访问。此时我们就需要借助DNS服务器来判断这个url后面到底是哪一个ip？

此时我们就需要从PC0发送数据包到Server3（DNS服务器），获取这个url所对应的ip地址。具体的通信过程在3.2小节。可能会问了我们怎么知道DNS的ip是啥呢？其实这个很简单，我们的电脑在创建自己的ip时都会给一个dns服务器ip，比如你在南方，这个dns服务器的ip就是南方的服务器ip，如果你在北方，这个ip就是北方的服务器ip（整个世界都已经将ip分配了，中国的ip范围是几到几，然后中国又更省份将ip再次进行划分，所以当看到一个ip就基本上可以知道这个ip是属于哪个大致区域了）。【当然网上也有教程说如果你的网络比较卡，简易将dns服务器换成百度或者谷歌的也就是这个道理，你访问一个url，你需要经过dns服务器来获取ip，但是如果dns服务器卡的话可想而知后续工作是不是也是卡的】说会正题，当PC0知道DNS服务器的ip之后，就利用TCP/IP发送相应的数据包给DNS服务器，然后DNS服务器返回相关url的ip地址给PC0。

### 4.2 通信

当获取到url所对应的ip之后，首先需要建立TCP三次握手协议，也就是说PC0根据tcp协议构建的数据包需要发送到相对应的ip地址（服务器），服务器返回一个数据包给PC0，然后PC0在发送一个数据包给服务器。当三次握手协议完成之后，接下来就是客户端通过HTTP协议构建相应的报文，然后根据TCP/IP协议组件相关的数据包发送到服务器。服务器在根据TCP/IP协议解析数据包然后在将客户端所需的资源返回给客户端即可。当请求完之后在利用四次挥手关闭连接即可。

**说明**：

1. 在浏览器中输入一个网址时，需要将它先解析出ip地址来
2. 当得到ip地址之后，浏览器以tcp的方式3次握手链接服务器
3. 以tcp的方式发送http协议的请求数据 给 服务器
4. 服务器tcp的方式回应http协议的应答数据 给浏览器
5. 由浏览器开始的四次挥手结束链接

## 五、总结

- MAC地址：在设备与设备之间数据通信时用来标记收发双方（网卡的序列号）
- IP地址：在逻辑上标记一台电脑，用来指引数据包的收发方向（相当于电脑的序列号）
- 网络掩码：用来区分ip地址的网络号和主机号
- 默认网关：当需要发送的数据包的目的ip不在本网段内时，就会发送给默认的一台电脑，称为网关
- 集线器：已过时，用来连接多态电脑，缺点：每次收发数据都进行广播，网络会变的拥堵
- 交换机：集线器的升级版，有学习功能知道需要发送给哪台设备，根据需要进行单播、广播
- 路由器：连接多个不同的网段，让他们之间可以进行收发数据，每次收到数据后，ip不变，但是MAC地址会变化
- DNS：用来解析出IP（类似电话簿）
- http服务器：提供浏览器能够访问到的数据