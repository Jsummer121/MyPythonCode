# 多任务

## 一、线程

​		线程是**操作系统调度**的单位，在Python中使用threading类中的Thread来创建函数，并且利用target指定线程需要执行的函数名称，也可以通过args传入元组参数放入其线程中。

​		线程之间共享全局变量，因此无需其余的东西来进行通信，但也因此会产生资源占用等情况，此时我们需要引入互斥锁，即当一个线程用到全局变量时，会将该值锁住，等待该线程执行完毕之后再解开。其余线程也是同样的方式利用互斥锁来保护全局变量。在使用互斥锁的同时还需要注意避免出现死锁的情况。死锁即A等待B的资源而B同样在等待A的资源。

​		在操作系统中，在线程之间切换需要耗费的资源一般，效率也一般，但是比起进程切换它已经非常高效了。

## 二、进程

​		进程是**资源分配**的单位，在python中使用multiprocessing类的Process来创建进程，其方法与Thread方法类似，利用target指定进程需要执行的函数名称，也可以通过args传入元素参数放入进程中。并且进程在操作系统中有唯一的一个pid号绑定，因此Process有一个多余的pid函数来获取该进程的进程号。同时也可以利用os模块的getpid来获取当前进程的进程号。

​		进程之间不共享全局变量，因此我们需要一个queue（队列）来进行进程之间的通信，该queue由multiprocessing的Queue提供，由a进程往队列中传值，这个值可以由b进程获取。这样就可以让进程之间相互通信。

​		我们知道，进程之间切换非常消耗资源同时进程的创建与死亡同样耗时耗力，当遇到大量的需求时，很可能会适得其反，此时可以引入一个进程池，由multiprocessing的Pool提供。我们创建一个进程池，然后在进程池中确定最大数量（与自己的机子有关，并不确定），此时就可以反复使用进程，使得效率提高。当用到进程池之后，我们就不能使用上面的队列了，需要一个全新的队列，这个队列由multiprocessing的Manager的Queue来提供，并且需要使用全新的apply_async函数来指定该进程需要执行的函数名。

## 三、协程

​		在说协程之前需要先知道生成器，生成器又是迭代器的一个特殊，那就先来说说迭代器，在python中，可以利用for..in...语法依次获取值的对象我们成为可迭代对象。我们知道for..in..语法是从该对象的第一个值开始取值直到最后一个，那么我们就需要引入一个”人“来记住当前以及取到第几个值了。我们把这个记东西的”人“称为迭代器。说直白一点：在python中，一个类它实现了`__iter__`方法就是可迭代对象，当调用这个函数的时候，返回值就是一个迭代器。迭代器在Python中就是同时实现了`__iter__`和`__next__`方法。

​		所以，**可迭代对象**的本质就是可以向我们提供一个这样的中间“人”即**迭代器**帮助我们对其进行迭代遍历使用。**迭代器**是用来帮助我们记录每次迭代访问到的位置，当我们对迭代器使用**next()**函数的时候，迭代器会向我们返回它所记录位置的下一个位置的数据。

​		那么什么是生成器呢？生成器很容易判断，如果一个函数中的return函数被变成了**yield**。此时该函数就升级变成了生成器，为什么说生成器也是迭代器的一种呢？因为当函数执行到yield的时候，就被阻塞挂起了，该函数返回一个yield所给的值。当函数调用next()方法时，便会继续执行yield的下面代码，如果是一个循环，那就再次进入循环再来一遍上面的过程。这里还需要注意一点就时当一个对象被yield过后，就相当于删除了值，如果第一遍用yield遍历所有值之后，第二遍将会得到一个空的对象。

​		在说回协程，协程是python个中另外一种实现多任务的方式，只不过比线程更小占用更小执行单元（理解为需要的资源）。 为啥说它是一个执行单元，因为它**自带CPU上下文**。这样只要在合适的时机， 我们可以把一个协程 切换到另一个协程。 只要这个过程中保存或恢复 CPU上下文那么程序还是可以运行的。这样理解：在一个线程中的某个函数，可以在任何地方保存当前函数的一些临时变量等信息，然后切换到另外一个函数中执行，注意不是通过调用函数的方式做到的，并且切换的次数以及什么时候再切换到原来的函数都由开发者自己确定。

​		我们一般使用gevent来创建协程，特别需要注意一点是，gevent的耗时操作需要使用他自己带的sleep函数，如果使用time的或者io阻塞的耗时操作，这会被忽视掉，使得整个还是按照线性在执行，那么我们可以引入一个monkey，它的monkey.patch_all()函数可以将整个代码放入一个空间，然后搜索所有的耗时函数，将他们自动转化为gevent的耗时函数。

​		因此，综上所述，进程是资源分配的单位，线程是系统调度的单位，而协程是比线程更小的执行单元。如果要在进程直线相互切换需要占用大量的资源（就相当于手机里面边打王者，边聊微信）。而线程所需要的资源一般，效率也是一般。因为操作系统为了程序运行的高效性每个线程都有自己缓存Cache等等数据，操作系统还会帮你做这些数据的恢复操作。 所以线程的切换非常耗性能。但是协程的切换只是单纯的操作CPU的上下文，所以一秒钟切换个上百万次系统都抗的住。